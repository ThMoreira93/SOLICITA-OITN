<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gestão de Materiais - Painel Administrativo</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;family=Open+Sans:wght@400;600&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    :root {
      /* Cores primárias */
      --primary-50: #e3f2fd;
      --primary-100: #bbdefb;
      --primary-200: #90caf9;
      --primary-300: #64b5f6;
      --primary-400: #42a5f5;
      --primary-500: #2196f3;  /* Cor principal */
      --primary-600: #1e88e5;
      --primary-700: #1976d2;
      --primary-800: #1565c0;
      --primary-900: #0d47a1;
      
      /* Cores secundárias */
      --secondary-500: #ff9800;  /* Laranja para destaque */
      
      /* Cores neutras */
      --neutral-50: #fafafa;
      --neutral-100: #f5f5f5;
      --neutral-200: #eeeeee;
      --neutral-300: #e0e0e0;
      --neutral-400: #bdbdbd;
      --neutral-500: #9e9e9e;
      --neutral-600: #757575;
      --neutral-700: #616161;
      --neutral-800: #424242;
      --neutral-900: #212121;
      
      /* Cores de status */
      --status-received: #9c27b0;     /* Solicitação Recebida */
      --status-generated: #1976d2;    /* Reserva Gerada */
      --status-waiting: #FFA500;      /* Aguardando Verba */
      --status-appropriated: #ec407a; /* Reserva Apropriada */
      --status-available: #757575;    /* Disponível para Retirada */
      --status-delivered: #2e7d32;    /* Material Entregue */
      --status-canceled: #ff0000;     /* Pedido Cancelado */
      
      /* Cores de feedback */
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
      --info: #2196f3;
      
      /* Tipografia */
      --font-primary: 'Roboto', sans-serif;
      --font-secondary: 'Open Sans', sans-serif;
      
      /* Espaçamento */
      --space-1: 0.25rem;  /* 4px */
      --space-2: 0.5rem;   /* 8px */
      --space-3: 0.75rem;  /* 12px */
      --space-4: 1rem;     /* 16px */
      --space-5: 1.25rem;  /* 20px */
      --space-6: 1.5rem;   /* 24px */
      --space-8: 2rem;     /* 32px */
      --space-10: 2.5rem;  /* 40px */
      --space-12: 3rem;    /* 48px */
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-primary);
      background-color: var(--neutral-100);
      color: var(--neutral-800);
      line-height: 1.5;
    }
    
    /* Layout principal */
    .app-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Barra lateral */
    .sidebar {
      width: 260px;
      background-color: var(--neutral-900);
      color: white;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }
    
    .sidebar-header {
      padding: var(--space-4);
      display: flex;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .logo {
      width: 40px;
      height: 40px;
      margin-right: var(--space-3);
    }
    
    .sidebar-header h1 {
      font-size: 1.25rem;
      font-weight: 500;
    }
    
    .sidebar-nav {
      flex: 1;
      padding: var(--space-4) 0;
      overflow-y: auto;
    }
    
    .nav-item {
      list-style: none;
    }
    
    .nav-item a {
      display: flex;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      color: var(--neutral-300);
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    .nav-item a:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .nav-item.active a {
      background-color: var(--primary-700);
      color: white;
      border-left: 4px solid var(--primary-300);
    }
    
    .nav-item i {
      margin-right: var(--space-3);
      width: 20px;
      text-align: center;
    }
    
    .sidebar-footer {
      padding: var(--space-4);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      margin-bottom: var(--space-3);
    }
    
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      margin-right: var(--space-3);
      object-fit: cover;
    }
    
    .user-details {
      display: flex;
      flex-direction: column;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    .user-role {
      font-size: 0.75rem;
      color: var(--neutral-400);
    }
    
    .btn-logout {
      display: flex;
      align-items: center;
      width: 100%;
      padding: var(--space-2) var(--space-3);
      background-color: transparent;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      color: var(--neutral-300);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-logout:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .btn-logout i {
      margin-right: var(--space-2);
    }
    
    /* Conteúdo principal */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: var(--space-4);
      transition: all 0.3s ease;
    }
    
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-6);
    }
    
    .page-title h2 {
      font-size: 1.75rem;
      font-weight: 500;
      color: var(--neutral-800);
      margin-bottom: var(--space-1);
    }
    
    .breadcrumb {
      font-size: 0.875rem;
      color: var(--neutral-500);
    }
    
    .header-actions {
      display: flex;
      align-items: center;
    }
    
    .search-container {
      position: relative;
      margin-right: var(--space-4);
    }
    
    .search-input {
      padding: var(--space-2) var(--space-4);
      padding-left: var(--space-8);
      border: 1px solid var(--neutral-300);
      border-radius: 4px;
      font-size: 0.875rem;
      width: 240px;
      transition: all 0.2s ease;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--primary-400);
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .btn-search {
      position: absolute;
      left: var(--space-2);
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--neutral-500);
      cursor: pointer;
    }
    
    /* Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-2) var(--space-4);
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    
    .btn i {
      margin-right: var(--space-2);
    }
    
    .btn-primary {
      background-color: var(--primary-600);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--primary-700);
    }
    
    .btn-secondary {
      background-color: var(--neutral-200);
      color: var(--neutral-800);
    }
    
    .btn-secondary:hover {
      background-color: var(--neutral-300);
    }
    
    .btn-icon {
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background-color: transparent;
      border: none;
      color: var(--neutral-600);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-icon:hover {
      background-color: var(--neutral-200);
      color: var(--neutral-800);
    }
    
    .btn-link {
      color: var(--primary-600);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .btn-link:hover {
      color: var(--primary-800);
      text-decoration: underline;
    }
    
    /* Cards */
    .card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      margin-bottom: var(--space-6);
      overflow: hidden;
    }
    
    .card-header {
      padding: var(--space-4);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--neutral-200);
    }
    
    .card-header h3 {
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--neutral-800);
    }
    
    .card-actions {
      display: flex;
      align-items: center;
    }
    
    .card-body {
      padding: var(--space-4);
    }
    
    .card-footer {
      padding: var(--space-4);
      border-top: 1px solid var(--neutral-200);
      display: flex;
      justify-content: flex-end;
    }
    
    /* KPI Cards */
    .kpi-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    
    .kpi-card {
      display: flex;
      align-items: center;
      padding: var(--space-4);
    }
    
    .kpi-icon {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      background-color: var(--primary-100);
      color: var(--primary-700);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: var(--space-4);
      font-size: 1.5rem;
    }
    
    .kpi-content {
      flex: 1;
    }
    
    .kpi-title {
      font-size: 0.875rem;
      color: var(--neutral-600);
      margin-bottom: var(--space-1);
    }
    
    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--neutral-900);
      margin-bottom: var(--space-1);
    }
    
    .kpi-change {
      font-size: 0.75rem;
      display: flex;
      align-items: center;
    }
    
    .kpi-change.positive {
      color: var(--success);
    }
    
    .kpi-change.negative {
      color: var(--error);
    }
    
    /* Grid Layout */
    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }
    
    /* Seções */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }
    
    .section-header h3 {
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--neutral-800);
    }
    
    /* Tabelas */
    .table-responsive {
      overflow-x: auto;
    }
    
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .table th, .table td {
      padding: var(--space-3) var(--space-4);
      text-align: left;
      border-bottom: 1px solid var(--neutral-200);
    }
    
    .table th {
      font-weight: 500;
      color: var(--neutral-700);
      background-color: var(--neutral-100);
      font-size: 0.875rem;
    }
    
    .table tr:hover {
      background-color: var(--neutral-50);
    }
    
    .table tr:last-child td {
      border-bottom: none;
    }
    
    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      line-height: 1.5;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .badge-received {
      background-color: var(--status-received);
      color: white;
    }
    
    .badge-generated {
      background-color: var(--status-generated);
      color: white;
    }
    
    .badge-waiting {
      background-color: var(--status-waiting);
      color: white;
    }
    
    .badge-appropriated {
      background-color: var(--status-appropriated);
      color: white;
    }
    
    .badge-available {
      background-color: var(--status-available);
      color: white;
    }
    
    .badge-delivered {
      background-color: var(--status-delivered);
      color: white;
    }
    
    .badge-canceled {
      background-color: var(--status-canceled);
      color: white;
    }
    
    /* Paginação */
    .pagination {
      display: flex;
      align-items: center;
    }
    
    .btn-page {
      padding: var(--space-1) var(--space-3);
      margin: 0 var(--space-1);
      border-radius: 4px;
      background-color: transparent;
      border: 1px solid var(--neutral-300);
      color: var(--neutral-700);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-page:hover {
      background-color: var(--neutral-100);
    }
    
    .btn-page.active {
      background-color: var(--primary-600);
      color: white;
      border-color: var(--primary-600);
    }
    
    /* Formulários */
    .form-group {
      margin-bottom: var(--space-4);
    }
    
    .form-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 500;
      font-size: 0.875rem;
      color: var(--neutral-700);
    }
    
    .form-control {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-300);
      border-radius: 4px;
      font-size: 0.875rem;
      transition: all 0.2s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary-400);
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    .form-select {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--neutral-300);
      border-radius: 4px;
      font-size: 0.875rem;
      background-color: white;
      transition: all 0.2s ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23616161' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right var(--space-3) center;
      background-size: 16px;
    }
    
    .form-select:focus {
      outline: none;
      border-color: var(--primary-400);
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    /* Notificações */
    .notification-container {
      position: fixed;
      top: var(--space-4);
      right: var(--space-4);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .notification {
      display: flex;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      background-color: white;
      max-width: 320px;
      animation: slideIn 0.3s ease forwards;
    }
    
    .notification-hiding {
      animation: slideOut 0.3s ease forwards;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    .notification-icon {
      margin-right: var(--space-3);
      font-size: 1.25rem;
    }
    
    .notification-content {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 500;
      margin-bottom: var(--space-1);
      font-size: 0.875rem;
    }
    
    .notification-message {
      font-size: 0.75rem;
      color: var(--neutral-600);
    }
    
    .notification-close {
      background: none;
      border: none;
      color: var(--neutral-500);
      cursor: pointer;
      padding: var(--space-1);
      margin-left: var(--space-2);
    }
    
    .notification-success .notification-icon {
      color: var(--success);
    }
    
    .notification-error .notification-icon {
      color: var(--error);
    }
    
    .notification-warning .notification-icon {
      color: var(--warning);
    }
    
    .notification-info .notification-icon {
      color: var(--info);
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
    }
    
    .modal.show {
      display: block;
    }
    
    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 500px;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    
    .modal-content {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    .modal-header {
      padding: var(--space-4);
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--neutral-800);
    }
    
    .btn-close {
      background: none;
      border: none;
      color: var(--neutral-500);
      cursor: pointer;
      font-size: 1.25rem;
      padding: var(--space-1);
    }
    
    .modal-body {
      padding: var(--space-4);
    }
    
    .modal-footer {
      padding: var(--space-4);
      border-top: 1px solid var(--neutral-200);
      display: flex;
      justify-content: flex-end;
      gap: var(--space-3);
    }
    
    /* Loading Indicator */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(33, 150, 243, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary-600);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Login */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: var(--neutral-100);
      padding: var(--space-4);
    }
    
    .login-card {
      width: 100%;
      max-width: 400px;
      padding: var(--space-8);
    }
    
    .login-header {
      text-align: center;
      margin-bottom: var(--space-6);
    }
    
    .login-logo {
      width: 64px;
      height: 64px;
      margin-bottom: var(--space-4);
    }
    
    .login-title {
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--neutral-800);
      margin-bottom: var(--space-2);
    }
    
    .login-subtitle {
      font-size: 0.875rem;
      color: var(--neutral-600);
    }
    
    .login-form {
      margin-bottom: var(--space-4);
    }
    
    .login-footer {
      text-align: center;
      font-size: 0.75rem;
      color: var(--neutral-500);
    }
    
    /* Pedidos */
    .pedido-card {
      margin-bottom: var(--space-4);
    }
    
    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-3);
    }
    
    .pedido-numero {
      font-size: 1.125rem;
      font-weight: 500;
      color: var(--secondary-500);
    }
    
    .pedido-data {
      font-size: 0.875rem;
      color: var(--neutral-600);
    }
    
    .pedido-info {
      margin-bottom: var(--space-4);
    }
    
    .pedido-info-item {
      display: flex;
      margin-bottom: var(--space-2);
    }
    
    .pedido-info-label {
      font-weight: 500;
      width: 120px;
      color: var(--neutral-700);
    }
    
    .pedido-info-value {
      flex: 1;
    }
    
    .pedido-materiais {
      margin-bottom: var(--space-4);
    }
    
    .pedido-status {
      display: flex;
      align-items: center;
      margin-top: var(--space-4);
    }
    
    .pedido-status-label {
      font-weight: 500;
      margin-right: var(--space-3);
    }
    
    .pedido-status-select {
      margin-left: var(--space-3);
    }
    
    .pedido-historico {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--neutral-200);
    }
    
    .pedido-historico-titulo {
      font-weight: 500;
      margin-bottom: var(--space-2);
    }
    
    .pedido-historico-lista {
      list-style: none;
      padding-left: var(--space-4);
    }
    
    .pedido-historico-item {
      position: relative;
      padding-left: var(--space-4);
      padding-bottom: var(--space-3);
      font-size: 0.875rem;
    }
    
    .pedido-historico-item::before {
      content: "";
      position: absolute;
      left: 0;
      top: 6px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--primary-500);
    }
    
    .pedido-historico-item::after {
      content: "";
      position: absolute;
      left: 3px;
      top: 14px;
      bottom: 0;
      width: 2px;
      background-color: var(--neutral-300);
    }
    
    .pedido-historico-item:last-child::after {
      display: none;
    }
    
    /* Responsividade */
    @media (max-width: 992px) {
      .sidebar {
        width: 64px;
      }
      
      .sidebar-header h1,
      .nav-item span,
      .user-details,
      .btn-logout span {
        display: none;
      }
      
      .main-content {
        margin-left: 64px;
      }
      
      .content-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-actions {
        margin-top: var(--space-3);
        width: 100%;
      }
      
      .search-container {
        flex: 1;
      }
      
      .search-input {
        width: 100%;
      }
    }
    
    @media (max-width: 768px) {
      .kpi-cards {
        grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
      }
      
      .grid-layout {
        grid-template-columns: 1fr;
      }
      
      .content-header {
        margin-bottom: var(--space-4);
      }
      
      .header-actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-container {
        margin-right: 0;
        margin-bottom: var(--space-3);
      }
    }
    
    @media (max-width: 576px) {
      .main-content {
        padding: var(--space-3);
      }
      
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .card-actions {
        margin-top: var(--space-2);
      }
      
      .pedido-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .pedido-data {
        margin-top: var(--space-1);
      }
    }
  </style>
<style>
/* Estilo do prompt customizado */
.custom-prompt-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  z-index: 9998;
  display: flex;
  align-items: center;
  justify-content: center;
}
.custom-prompt-container {
  background-color: white;
  padding: 2rem;
  border-radius: 12px;
  width: 90%;
  max-width: 400px;
  text-align: center;
  box-shadow: 0 0 15px rgba(0,0,0,0.25);
  z-index: 9999;
}
.custom-prompt-container input {
  width: 100%;
  padding: 0.6rem;
  margin: 1rem 0;
  border-radius: 6px;
  border: 1px solid #ccc;
}
.custom-prompt-buttons {
  display: flex;
  justify-content: center;
  gap: 1rem;
}
.custom-prompt-buttons button {
  padding: 0.5rem 1rem;
  border-radius: 6px;
  border: none;
  color: white;
  cursor: pointer;
}
.custom-prompt-buttons .confirm {
  background-color: #007bff;
}
.custom-prompt-buttons .cancel {
  background-color: #6c757d;
}
</style></head>
<body>
<!-- Tela de Login -->
<div class="login-container" id="loginContainer">
<div class="card login-card">
<div class="login-header">
<div style="width: 64px; height: 64px; background-color: var(--primary-600); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto var(--space-4);">
<i class="fas fa-boxes" style="font-size: 32px; color: white;"></i>
</div>
<h1 class="login-title">Gestão de Materiais</h1>
<p class="login-subtitle">Faça login para acessar o painel administrativo</p>
</div>
<form class="login-form" onsubmit="realizarLogin(event)">
<div class="form-group">
<label class="form-label" for="user">Usuário</label>
<input class="form-control" id="user" placeholder="Digite seu usuário" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label" for="pass">Senha</label>
<input class="form-control" id="pass" placeholder="Digite sua senha" required="" type="password"/>
</div>
<p id="loginErro" style="color: var(--error); font-size: 0.875rem; margin-top: var(--space-2); display: none;">
        Usuário ou senha incorretos.
      </p>
<button class="btn btn-primary" style="width: 100%; margin-top: var(--space-4);" type="submit">
<i class="fas fa-sign-in-alt"></i>
        Entrar
      </button>
</form>
<div class="login-footer">
<p>© 2025 Gestão de Materiais. Todos os direitos reservados.</p>
</div>
</div>
</div>
<!-- Painel Principal -->
<div class="app-container" id="conteudo" style="display: none;">
<!-- Barra lateral -->
<aside class="sidebar">
<div class="sidebar-header">
<div style="width: 40px; height: 40px; background-color: var(--primary-600); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
<i class="fas fa-boxes" style="font-size: 20px; color: white;"></i>
</div>
<h1>Gestão de Materiais</h1>
</div>
<nav class="sidebar-nav">
<ul>
<li class="nav-item active">
<a href="#dashboard" onclick="mostrarSecao('dashboard')">
<i class="fas fa-tachometer-alt"></i>
<span>Dashboard</span>
</a>
</li>
<li class="nav-item">
<a href="#pedidos" onclick="mostrarSecao('pedidos')">
<i class="fas fa-clipboard-list"></i>
<span>Pedidos</span>
</a>
</li>
<li class="nav-item">
<a href="#importacao" onclick="mostrarSecao('importacao')">
<i class="fas fa-file-import"></i>
<span>Importação</span>
</a>
</li>
<li class="nav-item">
<a href="#relatorios" onclick="mostrarSecao('relatorios')">
<i class="fas fa-chart-bar"></i>
<span>Relatórios</span>
</a>
</li>
</ul>
</nav>
<div class="sidebar-footer">
<div class="user-info">
<div style="width: 36px; height: 36px; background-color: var(--primary-700); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
<i class="fas fa-user" style="font-size: 16px; color: white;"></i>
</div>
<div class="user-details">
<span class="user-name">Admin</span>
<span class="user-role">Administrador</span>
</div>
</div>
<button class="btn-logout" onclick="realizarLogout()">
<i class="fas fa-sign-out-alt"></i>
<span>Sair</span>
</button>
</div>
</aside>
<!-- Conteúdo principal -->
<main class="main-content">
<!-- Seção Dashboard -->
<div id="secao-dashboard">
<header class="content-header">
<div class="page-title">
<h2>Dashboard</h2>
<p class="breadcrumb">Home &gt; Dashboard</p>
</div>
<div class="header-actions">
<div class="search-container">
<input class="search-input" id="buscaTexto" placeholder="Buscar pedidos..." type="text"/>
<button class="btn-search">
<i class="fas fa-search"></i>
</button>
</div>
<button class="btn btn-primary">
<i class="fas fa-plus"></i>
<span>Novo Pedido</span>
</button>
</div>
</header>
<!-- KPIs -->
<div class="kpi-cards">
<div class="card kpi-card" onclick="filtrarPorStatus('')" style="cursor: pointer;">
<div class="kpi-icon">
<i class="fas fa-clipboard-list"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Total de Pedidos</h3>
<p class="kpi-value" id="kpi-total">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
            </p>
</div>
</div>
<div class="card kpi-card" onclick="filtrarPorStatus('Aguardando Verba')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #ffecb3; color: #ff9800;">
<i class="fas fa-clock"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Aguardando Verba</h3>
<p class="kpi-value" id="kpi-aguardando">0</p>
<p class="kpi-change negative">
<i class="fas fa-arrow-up"></i> Atualizado
            </p>
</div>
</div>
<div class="card kpi-card" onclick="filtrarPorStatus('Disponível para Retirada')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #c8e6c9; color: #2e7d32;">
<i class="fas fa-check-circle"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Disponíveis</h3>
<p class="kpi-value" id="kpi-disponiveis">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
            </p>
</div>
</div>
<div class="card kpi-card" onclick="filtrarPorStatus('Material Entregue')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #e0e0e0; color: #616161;">
<i class="fas fa-truck"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Entregues</h3>
<p class="kpi-value" id="kpi-entregues">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
            </p>
</div>
</div>
<div class="card kpi-card" onclick="filtrarPorStatus('Solicitação Recebida')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #e1bee7; color: #9c27b0;">
<i class="fas fa-inbox"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Recebidos</h3>
<p class="kpi-value" id="kpi-recebidos">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
    </p>
</div>
</div><div class="card kpi-card" onclick="filtrarPorStatus('Reserva Gerada')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #bbdefb; color: #1976d2;">
<i class="fas fa-dolly-flatbed"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Gerados</h3>
<p class="kpi-value" id="kpi-gerados">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
    </p>
</div>
</div><div class="card kpi-card" onclick="filtrarPorStatus('Reserva Apropriada')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #f8bbd0; color: #ec407a;">
<i class="fas fa-file-signature"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Apropriados</h3>
<p class="kpi-value" id="kpi-apropriados">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
    </p>
</div>
</div><div class="card kpi-card" onclick="filtrarPorStatus('Pedido Cancelado')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #ffcdd2; color: #f44336;">
<i class="fas fa-ban"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Cancelados</h3>
<p class="kpi-value" id="kpi-cancelados">0</p>
<p class="kpi-change negative">
<i class="fas fa-arrow-up"></i> Atualizado
    </p>
</div>
</div><div class="card kpi-card" onclick="filtrarPorStatus('Aguardando Almoxarifado')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #dcedc8; color: #7cb342;">
<i class="fas fa-warehouse"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Almoxarifado</h3>
<p class="kpi-value" id="kpi-almoxarifado">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
    </p>
</div>
</div><div class="card kpi-card" onclick="filtrarPorStatus('Aguardando Material')" style="cursor: pointer;">
<div class="kpi-icon" style="background-color: #ffe0b2; color: #fb8c00;">
<i class="fas fa-box-open"></i>
</div>
<div class="kpi-content">
<h3 class="kpi-title">Aguardando Material</h3>
<p class="kpi-value" id="kpi-aguardando-material">0</p>
<p class="kpi-change positive">
<i class="fas fa-arrow-up"></i> Atualizado
    </p>
</div>
</div></div>
<!-- Gráficos -->
<div class="grid-layout">
<div class="card chart-card">
<div class="card-header">
<h3>Status dos Pedidos</h3>
<div class="card-actions">
<button class="btn-icon" title="Atualizar">
<i class="fas fa-sync-alt"></i>
</button>
<button class="btn-icon" title="Mais opções">
<i class="fas fa-ellipsis-v"></i>
</button>
</div>
</div>
<div class="card-body">
<canvas height="250" id="graficoStatus"></canvas>
</div>
</div>
</div>
<!-- Pedidos Recentes -->
<section>
<div class="section-header">
<h3>Pedidos Recentes</h3>
<a class="btn-link" href="#pedidos" onclick="mostrarSecao('pedidos')">Ver todos</a>
</div>
<div class="card">
<div class="table-responsive">
<table class="table" id="tabelaPedidosRecentes">
<thead>
<tr>
<th>Nº Pedido</th>
<th>Colaborador</th>
<th>Data</th>
<th>Status</th>
<th>Ações</th>
</tr>
</thead>
<tbody>
<!-- Preenchido via JavaScript -->
</tbody>
</table>
</div>
<div class="card-footer">
<div class="pagination">
<button class="btn-page" disabled="">Anterior</button>
<button class="btn-page active">1</button>
<button class="btn-page">2</button>
<button class="btn-page">3</button>
<button class="btn-page">Próximo</button>
</div>
</div>
</div>
</section>
</div>
<!-- Seção Pedidos -->
<div id="secao-pedidos" style="display: none;">
<header class="content-header">
<div class="page-title">
<h2>Pedidos</h2>
<p class="breadcrumb">Home &gt; Pedidos</p>
</div>
<div class="header-actions">
<div class="search-container">
<input class="search-input" id="buscaTextoPedidos" placeholder="Buscar por colaborador, número ou Focal..." type="text"/>
<button class="btn-search">
<i class="fas fa-search"></i>
</button>
</div>
            <select class="form-select" id="filtroStatus" style="width: auto; margin-right: var(--space-3);">
              <option value="">Todos os Status</option>
              <option>Solicitação Recebida</option>
              <option>Reserva Gerada</option>
              <option>Aguardando Verba</option>
              <option>Reserva Apropriada</option>
              <option>Disponível para Retirada</option>
              <option>Material Entregue</option>
              <option>Pedido Cancelado</option>
            </select>
            <select class="form-select" id="filtroFocal" style="width: auto; margin-right: var(--space-3);">
              <option value="">Todos os Focais</option>
            </select>
<button class="btn btn-primary">
<i class="fas fa-plus"></i>
<span>Novo Pedido</span>
</button>
</div>
</header>
<div id="listaPedidos">
<!-- Preenchido via JavaScript -->
</div>
<div class="card-footer" style="background-color: white; border-radius: 8px; margin-top: var(--space-4);">
<div class="pagination">
<button class="btn-page" disabled="">Anterior</button>
<button class="btn-page active">1</button>
<button class="btn-page">2</button>
<button class="btn-page">3</button>
<button class="btn-page">Próximo</button>
</div>
</div>
</div>
<!-- Seção Importação -->
<div id="secao-importacao" style="display: none;">
<header class="content-header">
<div class="page-title">
<h2>Importação</h2>
<p class="breadcrumb">Home &gt; Importação</p>
</div>
</header>
<div class="card">
<div class="card-header">
<h3>Atualização em Massa</h3>
</div>
<div class="card-body">
<p style="margin-bottom: var(--space-4);">
            Utilize esta ferramenta para atualizar o status de múltiplos pedidos de uma só vez através de uma planilha Excel.
          </p>
<div class="form-group">
<label class="form-label" for="arquivoStatus">Selecione a planilha</label>
<input accept=".xlsx, .xls" class="form-control" id="arquivoStatus" type="file"/>
<small style="display: block; margin-top: var(--space-2); color: var(--neutral-600);">
              A planilha deve conter as colunas "Número do Pedido" e "Novo Status".
            </small>
</div>
<div style="display: flex; gap: var(--space-3); margin-top: var(--space-4);">
<button class="btn btn-primary" onclick="atualizarStatusEmMassa()">
<i class="fas fa-upload"></i>
              Atualizar em Massa
            </button>
<a download="" href="Modelo_Atualizacao_Status.xlsx">
<button class="btn btn-secondary">
<i class="fas fa-download"></i>
                Baixar Modelo
              </button>
</a>
</div>
</div>
</div>
<div class="card" style="margin-top: var(--space-6);">
<div class="card-header">
<h3>Exportar Dados</h3>
</div>
<div class="card-body">
<p style="margin-bottom: var(--space-4);">
            Configure os filtros desejados e exporte os pedidos para uma planilha Excel personalizada.
          </p>
          
          <!-- Filtros de Exportação -->
          <div class="form-group">
            <h4 style="margin-bottom: var(--space-3); color: var(--neutral-700);">Filtros de Exportação</h4>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-4);">
              
              <!-- Filtro por Focal -->
              <div class="form-group">
                <label class="form-label" for="exportFiltroFocal">Focal:</label>
                <select class="form-select" id="exportFiltroFocal" multiple>
                  <option value="">Todos os Focais</option>
                </select>
                <small style="color: var(--neutral-600); font-size: 0.75rem;">Ctrl+Click para múltipla seleção</small>
              </div>
              
              <!-- Filtro por Status do Pedido -->
              <div class="form-group">
                <label class="form-label" for="exportFiltroStatusPedido">Status do Pedido:</label>
                <select class="form-select" id="exportFiltroStatusPedido" multiple>
                  <option value="">Todos os Status</option>
                  <option value="Solicitação Recebida">Solicitação Recebida</option>
                  <option value="Reserva Gerada">Reserva Gerada</option>
                  <option value="Aguardando Verba">Aguardando Verba</option>
                  <option value="Reserva Apropriada">Reserva Apropriada</option>
                  <option value="Disponível para Retirada">Disponível para Retirada</option>
                  <option value="Material Entregue">Material Entregue</option>
                  <option value="Pedido Cancelado">Pedido Cancelado</option>
                  <option value="Aguardando Almoxarifado">Aguardando Almoxarifado</option>
                  <option value="Aguardando Material">Aguardando Material</option>
                </select>
                <small style="color: var(--neutral-600); font-size: 0.75rem;">Ctrl+Click para múltipla seleção</small>
              </div>
              
              <!-- Filtro por Status do Item -->
              <div class="form-group">
                <label class="form-label" for="exportFiltroStatusItem">Status do Item:</label>
                <select class="form-select" id="exportFiltroStatusItem" multiple>
                  <option value="">Todos os Status</option>
                  <option value="Solicitação Recebida">Solicitação Recebida</option>
                  <option value="Reserva Gerada">Reserva Gerada</option>
                  <option value="Aguardando Verba">Aguardando Verba</option>
                  <option value="Reserva Apropriada">Reserva Apropriada</option>
                  <option value="Disponível para Retirada">Disponível para Retirada</option>
                  <option value="Material Entregue">Material Entregue</option>
                  <option value="Pedido Cancelado">Pedido Cancelado</option>
                  <option value="Aguardando Almoxarifado">Aguardando Almoxarifado</option>
                  <option value="Aguardando Material">Aguardando Material</option>
                </select>
                <small style="color: var(--neutral-600); font-size: 0.75rem;">Ctrl+Click para múltipla seleção</small>
              </div>
              
              <!-- Filtro por Material -->
              <div class="form-group">
                <label class="form-label" for="exportFiltroMaterial">Material:</label>
                <input class="form-control" id="exportFiltroMaterial" type="text" placeholder="Digite o nome do material...">
                <small style="color: var(--neutral-600); font-size: 0.75rem;">Busca por nome do material</small>
              </div>
              
              <!-- Filtro por Colaborador -->
              <div class="form-group">
                <label class="form-label" for="exportFiltroColaborador">Colaborador:</label>
                <input class="form-control" id="exportFiltroColaborador" type="text" placeholder="Digite o nome do colaborador...">
                <small style="color: var(--neutral-600); font-size: 0.75rem;">Busca por nome do colaborador</small>
              </div>
              
              <!-- Filtro por Data -->
              <div class="form-group">
                <label class="form-label" for="exportDataInicio">Data Início:</label>
                <input class="form-control" id="exportDataInicio" type="date">
              </div>
              
              <div class="form-group">
                <label class="form-label" for="exportDataFim">Data Fim:</label>
                <input class="form-control" id="exportDataFim" type="date">
              </div>
              
            </div>
            
            <!-- Opções de Colunas -->
            <div class="form-group" style="margin-top: var(--space-4);">
              <h4 style="margin-bottom: var(--space-3); color: var(--neutral-700);">Colunas para Exportar</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-2);">
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colNumeroPedido" checked style="margin-right: var(--space-2);"> Número do Pedido
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colColaborador" checked style="margin-right: var(--space-2);"> Colaborador
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colFocal" checked style="margin-right: var(--space-2);"> Focal
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colStatusPedido" checked style="margin-right: var(--space-2);"> Status do Pedido
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colMaterial" checked style="margin-right: var(--space-2);"> Material
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colQuantidade" checked style="margin-right: var(--space-2);"> Quantidade
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colStatusItem" checked style="margin-right: var(--space-2);"> Status do Item
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colObservacoes" checked style="margin-right: var(--space-2);"> Observações
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                  <input type="checkbox" id="colData" checked style="margin-right: var(--space-2);"> Data
                </label>
              </div>
            </div>
            
            <!-- Botões de Ação -->
            <div style="display: flex; gap: var(--space-3); margin-top: var(--space-4); align-items: center;">
              <button class="btn btn-primary" onclick="exportarExcelFiltrado()">
                <i class="fas fa-file-export"></i>
                Exportar Excel Filtrado
              </button>
              <button class="btn btn-secondary" onclick="limparFiltrosExportacao()">
                <i class="fas fa-eraser"></i>
                Limpar Filtros
              </button>
              <span id="contadorResultados" style="color: var(--neutral-600); font-size: 0.875rem;"></span>
            </div>
          </div>
</div>
</div>
</div>
<!-- Seção Relatórios -->
<div id="secao-relatorios" style="display: none;">
<header class="content-header">
<div class="page-title">
<h2>Relatórios</h2>
<p class="breadcrumb">Home &gt; Relatórios</p>
</div>
</header>
<div class="card">
<div class="card-header">
<h3>Gerar Relatórios</h3>
</div>
<div class="card-body">
<div class="form-group">
<label class="form-label" for="tipoRelatorio">Tipo de Relatório:</label>
<select class="form-select" id="tipoRelatorio">
<option value="status">Distribuição por Status</option>
<option value="mensal">Pedidos por Mês</option>
<option value="colaborador">Pedidos por Colaborador</option>
</select>
</div>
<div class="form-group">
<label class="form-label" for="dataInicioRelatorio">Data Início:</label>
<input class="form-control" id="dataInicioRelatorio" type="date"/>
</div>
<div class="form-group">
<label class="form-label" for="dataFimRelatorio">Data Fim:</label>
<input class="form-control" id="dataFimRelatorio" type="date"/>
</div>
<button class="btn btn-primary" onclick="gerarRelatorio()">
<i class="fas fa-cogs"></i>
            Gerar Relatório
          </button>
</div>
</div>
<div class="card" id="resultadoRelatorio" style="margin-top: var(--space-6); display: none;">
<div class="card-header">
<h3 id="tituloResultadoRelatorio">Resultado do Relatório</h3>
<button class="btn btn-secondary" onclick="exportarRelatorioExcel()">
<i class="fas fa-file-export"></i>
            Exportar para Excel
          </button>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table" id="tabelaRelatorio">
<thead>
<!-- Cabeçalho preenchido via JavaScript -->
</thead>
<tbody>
<!-- Dados preenchidos via JavaScript -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</main>
</div>
<!-- Notificações -->
<div class="notification-container" id="notificationContainer"></div>
<!--<!-- Modal de Confirmação ---->
<div class="modal" id="confirmationModal">
<div class="modal-backdrop"></div>
<div class="modal-container">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title">Confirmar Ação</h4>
<button class="btn-close" data-dismiss="modal" onclick="fecharModal('confirmationModal')">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<p>Tem certeza que deseja atualizar o status deste pedido?</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="fecharModal('confirmationModal')">Cancelar</button>
<button class="btn btn-primary" id="confirmAction">Confirmar</button>
</div>
</div>
</div>
</div>
<!-- Modal de Troca de Senha -->
<div class="modal" id="trocaSenhaModal">
<div class="modal-backdrop"></div>
<div class="modal-container">
<div class="modal-content">
<div class="modal-header">
<h4 class="modal-title">Alterar Senha</h4>
</div>
<div class="modal-body">
<p>Este é seu primeiro login. Por favor, altere sua senha.</p>
<div class="form-group">
<label class="form-label" for="novaSenha">Nova Senha:</label>
<input class="form-control" id="novaSenha" placeholder="Digite sua nova senha" type="password"/>
</div>
<div class="form-group">
<label class="form-label" for="confirmaSenha">Confirmar Senha:</label>
<input class="form-control" id="confirmaSenha" placeholder="Confirme sua nova senha" type="password"/>
</div>
<div class="alert alert-danger" id="trocaSenhaErro" style="display: none;"></div>
</div>
<div class="modal-footer">
<button class="btn btn-primary" onclick="trocarSenha()">Alterar Senha</button>
</div>
</div>
</div>
</div>
<!-- Loading Indicator -->
<div class="loading-indicator" id="loadingIndicator" style="display: none;">
<div class="spinner"></div>
</div>
<script>
// Configuração do Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBebzbWyaxJBForcbSBTQPR8DbCCUyo4Mo",
  authDomain: "solicitacao-de-material-itn.firebaseapp.com",
  projectId: "solicitacao-de-material-itn",
  storageBucket: "solicitacao-de-material-itn.firebasestorage.app",
  messagingSenderId: "486465305117",
  appId: "1:486465305117:web:2e5841d3136c58743224f4",
  measurementId: "G-SWLCG6866E"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Constantes
const STATUS_OPTIONS = [
  "Solicitação Recebida",
  "Reserva Gerada",
  "Aguardando Verba",
  "Reserva Apropriada",
  "Disponível para Retirada",
  "Material Entregue",
  "Pedido Cancelado",
  "Aguardando Almoxarifado",
  "Aguardando Material"
];

const STATUS_COLORS = {
  "Solicitação Recebida": "var(--status-received)",
  "Reserva Gerada": "var(--status-generated)",
  "Aguardando Verba": "var(--status-waiting)",
  "Reserva Apropriada": "var(--status-appropriated)",
  "Disponível para Retirada": "var(--status-available)",
  "Material Entregue": "var(--status-delivered)",
  "Pedido Cancelado": "var(--status-canceled)"
};

const STATUS_BADGES = {
  "Solicitação Recebida": "badge-received",
  "Reserva Gerada": "badge-generated",
  "Aguardando Verba": "badge-waiting",
  "Reserva Apropriada": "badge-appropriated",
  "Disponível para Retirada": "badge-available",
  "Material Entregue": "badge-delivered",
  "Pedido Cancelado": "badge-canceled"
};

// Variáveis globais
let todosPedidos = [];
let pedidosFiltrados = [];
let confirmCallback = null;

// Usuários do sistema
const USUARIOS = {
  "CLB354374": { senha: "*2025*Coelba", nome: "THIAGO MOREIRA", cargo: "ADMINISTRADOR", primeiroLogin: false },
  "153133": { senha: "Coelba*2020", nome: "ALISSON", cargo: "TEC. ESPECIALISTA", primeiroLogin: false },
  "162299": { senha: "Coelba*2021", nome: "CLARA", cargo: "TEC. MANUTENÇÃO", primeiroLogin: false },
  "961188": { senha: "Coelba*2022", nome: "SHAYANNE", cargo: "TEC. COMERCIAL", primeiroLogin: false },
  "162522": { senha: "Coelba*2023", nome: "THAIS", cargo: "FOCAL OPEX", primeiroLogin: false },
  "124389": { senha: "Coelba*2030", nome: "J. CLAUDIO", cargo: "ANALISTA ALMOX.", primeiroLogin: false },
  "154784": { senha: "Coelba*2029", nome: "ANA CARLA", cargo: "MELHOR ALMOXARIFE DA BAHIA", primeiroLogin: false },
  "B621952": { senha: "Coelba*621952", nome: "E. BEZERRA", cargo: "ESTAGIÁRIO", primeiroLogin: false },
  "121266": { senha: "Coelba*2024", nome: "VALÉRIA", cargo: "FOCAL PERDAS", primeiroLogin: false },
  "960219": { senha: "Coelba*2025", nome: "EBER", cargo: "TEC. MANUTENÇÃO", primeiroLogin: false }
};

// Autenticação
function realizarLogin(e) {
  e.preventDefault();
  showLoadingIndicator();
  
  const u = document.getElementById("user").value;
  const p = document.getElementById("pass").value;
  
  // Simulação de delay para mostrar o loading
  setTimeout(() => {
    hideLoadingIndicator();
    
    if (USUARIOS[u] && USUARIOS[u].senha === p) {
      // Armazenar informações do usuário logado
      const usuarioLogado = {
        usuario: u,
        nome: USUARIOS[u].nome,
        cargo: USUARIOS[u].cargo,
        primeiroLogin: USUARIOS[u].primeiroLogin,
        timestamp: Date.now()
      };
      
      localStorage.setItem("usuarioLogado", JSON.stringify(usuarioLogado));
      
      // Verificar se é primeiro login
      if (USUARIOS[u].primeiroLogin) {
        // Mostrar modal para troca de senha
        showTrocaSenhaModal();
      } else {
        // Login normal
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("conteudo").style.display = "block";
        
        // Atualizar informações do usuário na interface
        document.querySelector(".user-name").textContent = USUARIOS[u].nome;
        document.querySelector(".user-role").textContent = USUARIOS[u].cargo;
        
        carregarPedidos();
        showNotification("Login realizado com sucesso!", "success");
      }
    } else {
      document.getElementById("loginErro").style.display = "block";
      showNotification("Falha no login. Verifique suas credenciais.", "error");
    }
  }, 1000);
}

// Modal para troca de senha no primeiro login
function showTrocaSenhaModal() {
  const modal = document.getElementById('trocaSenhaModal');
  modal.classList.add('show');
}

// Função para trocar senha no primeiro login
function trocarSenha() {
  const novaSenha = document.getElementById("novaSenha").value;
  const confirmaSenha = document.getElementById("confirmaSenha").value;
  
  // Validar senha
  if (novaSenha.length < 6) {
    document.getElementById("trocaSenhaErro").textContent = "A senha deve ter pelo menos 6 caracteres";
    document.getElementById("trocaSenhaErro").style.display = "block";
    return;
  }
  
  if (novaSenha !== confirmaSenha) {
    document.getElementById("trocaSenhaErro").textContent = "As senhas não coincidem";
    document.getElementById("trocaSenhaErro").style.display = "block";
    return;
  }
  
  // Obter usuário logado
  const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
  
  // Atualizar senha
  USUARIOS[usuarioLogado.usuario].senha = novaSenha;
  USUARIOS[usuarioLogado.usuario].primeiroLogin = false;
  
  // Atualizar informações do usuário logado
  usuarioLogado.primeiroLogin = false;
  localStorage.setItem("usuarioLogado", JSON.stringify(usuarioLogado));
  
  // Registrar alteração de senha
  registrarAcao("Alteração de senha", "Senha alterada no primeiro login");
  
  // Fechar modal
  fecharModal('trocaSenhaModal');
  
  // Mostrar conteúdo
  document.getElementById("loginContainer").style.display = "none";
  document.getElementById("conteudo").style.display = "block";
  
  // Atualizar informações do usuário na interface
  document.querySelector(".user-name").textContent = usuarioLogado.nome;
  document.querySelector(".user-role").textContent = usuarioLogado.cargo;
  
  carregarPedidos();
  showNotification("Senha alterada com sucesso!", "success");
}

// Registro de ações do usuário
function registrarAcao(tipo, descricao, detalhes = {}) {
  // Obter usuário logado
  const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (!usuarioLogado) return;
  
  // Criar registro de ação
  const acao = {
    tipo: tipo,
    descricao: descricao,
    usuario: usuarioLogado.usuario,
    nome: usuarioLogado.nome,
    cargo: usuarioLogado.cargo,
    data: new Date().toISOString(),
    detalhes: detalhes
  };
  
  // Obter registros existentes
  let registros = JSON.parse(localStorage.getItem("registroAcoes")) || [];
  
  // Adicionar novo registro
  registros.push(acao);
  
  // Salvar registros
  localStorage.setItem("registroAcoes", JSON.stringify(registros));
  
  // Se estiver conectado ao Firebase, salvar também no banco de dados
  if (db) {
    db.collection("registroAcoes").add(acao)
      .catch(error => console.error("Erro ao salvar registro de ação:", error));
  }
}

function verificaLogin() {
  const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
  if (usuarioLogado && Date.now() - usuarioLogado.timestamp < 1800000) {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("conteudo").style.display = "block";
    
    // Atualizar informações do usuário na interface
    document.querySelector(".user-name").textContent = usuarioLogado.nome;
    document.querySelector(".user-role").textContent = usuarioLogado.cargo;
    
    carregarPedidos();
  }
}

function realizarLogout() {
  showConfirmationModal(
    "Deseja realmente sair?",
    "Você será redirecionado para a tela de login.",
    () => {
      // Registrar ação de logout
      registrarAcao("Logout", "Usuário realizou logout do sistema");
      
      // Remover dados de login
      localStorage.removeItem("usuarioLogado");
      
      // Redirecionar para tela de login
      document.getElementById("loginContainer").style.display = "flex";
      document.getElementById("conteudo").style.display = "none";
      showNotification("Logout realizado com sucesso!", "info");
    }
  );
}

// Navegação
function mostrarSecao(secao) {
  // Ocultar todas as seções
  document.getElementById("secao-dashboard").style.display = "none";
  document.getElementById("secao-pedidos").style.display = "none";
  document.getElementById("secao-importacao").style.display = "none";
  document.getElementById("secao-relatorios").style.display = "none";
  
  // Remover classe active de todos os itens de navegação
  document.querySelectorAll(".nav-item").forEach(item => {
    item.classList.remove("active");
  });
  
  // Mostrar a seção selecionada
  document.getElementById(`secao-${secao}`).style.display = "block";
  
  // Adicionar classe active ao item de navegação correspondente
  document.querySelector(`.nav-item a[href="#${secao}"]`).parentElement.classList.add("active");
}

// Carregamento de dados
function carregarPedidos() {
  showLoadingIndicator();
  
  db.collection("pedidos").orderBy("data", "desc").onSnapshot(snap => {
    todosPedidos = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    pedidosFiltrados = [...todosPedidos];
    
    renderizarPedidos(todosPedidos);
    atualizarTabelaPedidosRecentes();
    gerarGraficoStatus(todosPedidos);
    atualizarKPIs(todosPedidos);
    popularFiltroFocal(todosPedidos);
    inicializarFiltrosExportacao();
    
    hideLoadingIndicator();
  }, error => {
    console.error("Erro ao carregar pedidos:", error);
    showNotification("Erro ao carregar pedidos. Tente novamente mais tarde.", "error");
    hideLoadingIndicator();
  });
}

// Renderização de pedidos
function renderizarPedidos(lista) {
  const div = document.getElementById("listaPedidos");
  div.innerHTML = "";
  
  if (lista.length === 0) {
    div.innerHTML = `
      <div class="card" style="text-align: center; padding: var(--space-8);">
        <i class="fas fa-search" style="font-size: 48px; color: var(--neutral-400); margin-bottom: var(--space-4);"></i>
        <h3 style="margin-bottom: var(--space-2);">Nenhum pedido encontrado</h3>
        <p style="color: var(--neutral-600);">Tente ajustar os filtros ou criar um novo pedido.</p>
      </div>
    `;
    return;
  }
  
  lista.forEach(p => {
    const historico = (p.historico || []).map(h => 
      `<li class="pedido-historico-item">${new Date(h.data).toLocaleString()} - ${h.status}</li>`
    ).join("");
    
    const card = document.createElement("div");
    card.className = "card pedido-card";
    card.innerHTML = `
      <div class="card-body">
        <div class="pedido-header">
          <div class="pedido-numero">Pedido: ${p.numero}</div>
          <div class="pedido-data">${new Date(p.data).toLocaleString()}</div>
        </div>
        
        <div class="pedido-info">
          <div class="pedido-info-item">
            <div class="pedido-info-label">Colaborador:</div>
            <div class="pedido-info-value">${p.colaborador}</div>
          </div>
          <div class="pedido-info-item">
            <div class="pedido-info-label">Focal:</div>
            <div class="pedido-info-value">${p.Focal}</div>
          </div>
          <div class="pedido-info-item">
            <div class="pedido-info-label">Observações:</div>
            <div class="pedido-info-value">${p.observacoes || "Nenhuma observação"}</div>
          </div>
        </div>
        
        <div class="pedido-materiais">
          <h4 style="margin-bottom: var(--space-3);">Materiais</h4>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Material</th>
                  <th>Quantidade</th>
                  <th>Status</th>
                  <th>Ação</th>
                </tr>
              </thead>
              <tbody>
                ${(p.materiais || []).map((m, idx) => `
                  <tr>
                    <td>${m.material}</td>
                    <td>${m.quantidade}</td>
                    <td>
                      <span style="color: #2e7d32; font-weight: bold;">${m.status || p.status}</span>
                    </td>
                    <td>
                      <select class="form-select" onchange="atualizarStatusItem('${p.id}', ${idx}, this.value)">
                        ${STATUS_OPTIONS.map(s => 
                          `<option value="${s}" ${s === (m.status || p.status) ? "selected" : ""}>${s}</option>`
                        ).join("")}
                      </select>
                    </td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="pedido-status">
          <div class="pedido-status-label">Status do Pedido:</div>
          <span class="badge ${STATUS_BADGES[p.status] || 'badge-received'}">${p.status}</span>
          <div class="pedido-status-select">
            <select class="form-select" onchange="atualizarStatusIndividual('${p.id}', this.value)">
              ${STATUS_OPTIONS.map(s => 
                `<option value="${s}" ${s === p.status ? "selected" : ""}>${s}</option>`
              ).join("")}
            </select>
          </div>
        </div>
        
        <div class="pedido-historico">
          <h4 class="pedido-historico-titulo">Histórico</h4>
          <ul class="pedido-historico-lista">
            ${historico || "<li class='pedido-historico-item'>Nenhum histórico disponível</li>"}
          </ul>
        </div>
      </div>
    `;
    
    div.appendChild(card);
  });
}

// Atualização de status
function atualizarStatusIndividual(id, valor) {
  showConfirmationModal(
    "Confirmar alteração de status",
    `Deseja alterar o status do pedido para "${valor}"?`,
    () => {
      showLoadingIndicator();
      
      const ref = db.collection("pedidos").doc(id);
      ref.get().then(doc => {
        if (doc.exists) {
          const dados = doc.data();
          const historico = dados.historico || [];
          
          // Obter usuário logado
          const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
          
          // Criar entrada de histórico com informações do usuário
          const novaEntrada = { 
            status: valor, 
            data: new Date().toISOString(),
            usuario: usuarioLogado ? usuarioLogado.usuario : "sistema",
            nome: usuarioLogado ? usuarioLogado.nome : "Sistema"
          };
          
          historico.push(novaEntrada);
          
          // Atualizar também os status dos itens individuais
          const materiais = dados.materiais || [];
          materiais.forEach(material => {
            // Criar ou atualizar o histórico do item
            if (!material.historico) {
              material.historico = [];
            }
            
            // Adicionar entrada ao histórico do item
            material.historico.push({
              status: valor,
              data: new Date().toISOString(),
              usuario: usuarioLogado ? usuarioLogado.usuario : "sistema",
              nome: usuarioLogado ? usuarioLogado.nome : "Sistema"
            });
            
            // Atualizar o status do item
            material.status = valor;
          });
          
          ref.update({ status: valor, historico: historico, materiais: materiais })
            .then(() => {
              hideLoadingIndicator();
              showNotification(`Status do pedido atualizado para "${valor}"`, "success");
              
              // Registrar ação
              registrarAcao("Alteração de Status", `Status do pedido ${dados.numero} alterado para "${valor}"`, {
                pedidoId: id,
                numeroPedido: dados.numero,
                statusAntigo: dados.status,
                statusNovo: valor
              });
              
              // Reaplicar filtros para manter a filtragem ativa
              aplicarFiltros();
            })
            .catch(error => {
              console.error("Erro ao atualizar status:", error);
              hideLoadingIndicator();
              showNotification("Erro ao atualizar status. Tente novamente.", "error");
            });
        }
      });
    }
  );
}

function atualizarStatusItem(pedidoId, itemIndex, novoStatus) {
  showConfirmationModal(
    "Confirmar alteração de status",
    `Deseja alterar o status do item para "${novoStatus}"?`,
    () => {
      showLoadingIndicator();
      
      const ref = db.collection("pedidos").doc(pedidoId);
      ref.get().then(doc => {
        if (doc.exists) {
          const dados = doc.data();
          const materiais = dados.materiais || [];
          
          // Verificar se o índice é válido
          if (itemIndex >= 0 && itemIndex < materiais.length) {
            // Criar ou atualizar o histórico do item
            if (!materiais[itemIndex].historico) {
              materiais[itemIndex].historico = [];
            }
            
            // Obter usuário logado
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            
            // Adicionar entrada ao histórico do item com informações do usuário
            materiais[itemIndex].historico.push({
              status: novoStatus,
              data: new Date().toISOString(),
              usuario: usuarioLogado ? usuarioLogado.usuario : "sistema",
              nome: usuarioLogado ? usuarioLogado.nome : "Sistema"
            });
            
            // Atualizar o status do item
            materiais[itemIndex].status = novoStatus;
            
            // Atualizar o documento no Firestore
            ref.update({ materiais: materiais })
              .then(() => {
                hideLoadingIndicator();
                showNotification(`Status do item atualizado para "${novoStatus}"`, "success");
                
                // Registrar ação
                registrarAcao("Alteração de Status de Item", `Status do item ${materiais[itemIndex].material} alterado para "${novoStatus}"`, {
                  pedidoId: pedidoId,
                  numeroPedido: dados.numero,
                  material: materiais[itemIndex].material,
                  statusAntigo: materiais[itemIndex].status || dados.status,
                  statusNovo: novoStatus
                });
                
                // Reaplicar filtros para manter a filtragem ativa
                aplicarFiltros();
              })
              .catch(error => {
                console.error("Erro ao atualizar status do item:", error);
                hideLoadingIndicator();
                showNotification("Erro ao atualizar o status do item. Tente novamente.", "error");
              });
          }
        }
      });
    }
  );
}

// Filtros
function aplicarFiltros() {
  const status = document.getElementById("filtroStatus").value;
  const focal = document.getElementById("filtroFocal").value;
  const texto = document.getElementById("buscaTextoPedidos").value.toLowerCase() || 
                document.getElementById("buscaTexto").value.toLowerCase();
  
  pedidosFiltrados = todosPedidos.filter(p =>
    (!status || p.status === status) &&
    (!focal || p.Focal === focal) &&
    (!texto || 
     p.colaborador.toLowerCase().includes(texto) || 
     p.numero.toString().includes(texto) || 
     p.Focal.includes(texto))
  );
  
  renderizarPedidos(pedidosFiltrados);
  gerarGraficoStatus(pedidosFiltrados);
}

// Event Listeners para filtros
document.addEventListener('DOMContentLoaded', function() {
  const buscaTexto = document.getElementById("buscaTexto");
  const buscaTextoPedidos = document.getElementById("buscaTextoPedidos");
  const filtroStatus = document.getElementById("filtroStatus");
  const filtroFocal = document.getElementById("filtroFocal");
  
  if (buscaTexto) buscaTexto.addEventListener("input", aplicarFiltros);
  if (buscaTextoPedidos) buscaTextoPedidos.addEventListener("input", aplicarFiltros);
  if (filtroStatus) filtroStatus.addEventListener("change", aplicarFiltros);
  if (filtroFocal) filtroFocal.addEventListener("change", aplicarFiltros);
});

// Função para popular o filtro de Focal
function popularFiltroFocal(pedidos) {
  const filtroFocal = document.getElementById("filtroFocal");
  if (!filtroFocal) return;
  
  // Obter valores únicos de Focal
  const focaisUnicos = [...new Set(pedidos.map(p => p.Focal).filter(focal => focal && focal.trim() !== ""))];
  focaisUnicos.sort();
  
  // Limpar opções existentes (exceto a primeira)
  while (filtroFocal.children.length > 1) {
    filtroFocal.removeChild(filtroFocal.lastChild);
  }
  
  // Adicionar opções de Focal
  focaisUnicos.forEach(focal => {
    const option = document.createElement("option");
    option.value = focal;
    option.textContent = focal;
    filtroFocal.appendChild(option);
  });
}

// Função para filtrar por status ao clicar nos cards do dashboard
function filtrarPorStatus(status) {
  // Mudar para a seção de pedidos
  mostrarSecao('pedidos');
  
  // Definir o filtro de status
  const filtroStatus = document.getElementById("filtroStatus");
  if (filtroStatus) {
    filtroStatus.value = status;
  }
  
  // Aplicar os filtros
  aplicarFiltros();
}

// Atualização em massa
function atualizarStatusEmMassa() {
  const file = document.getElementById("arquivoStatus").files[0];
  if (!file) {
    showNotification("Selecione uma planilha para continuar.", "warning");
    return;
  }
  
  showLoadingIndicator();
  showNotification("Processando planilha. Aguarde...", "info");
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      // Ler a planilha
      const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
      
      // Verificar se a planilha tem a Sheet1
      if (!workbook.Sheets.Sheet1) {
        hideLoadingIndicator();
        showNotification("Formato de planilha inválido. Use o modelo fornecido.", "error");
        return;
      }
      
      const dados = XLSX.utils.sheet_to_json(workbook.Sheets.Sheet1);
      
      // Verificar se há dados
      if (dados.length === 0) {
        hideLoadingIndicator();
        showNotification("A planilha não contém dados para atualização.", "warning");
        return;
      }
      
      // Verificar se as colunas necessárias existem
      if (!dados[0].hasOwnProperty("Número do Pedido") || !dados[0].hasOwnProperty("Novo Status")) {
        hideLoadingIndicator();
        showNotification("A planilha não contém as colunas necessárias. Use o modelo fornecido.", "error");
        return;
      }
      
      // Array para armazenar resultados
      let atualizados = 0;
      let naoEncontrados = 0;
      let statusInvalidos = 0;
      
      const promessas = dados.map(row => {
        // Verificar se o número do pedido é válido
        if (!row["Número do Pedido"] || isNaN(parseInt(row["Número do Pedido"]))) {
          naoEncontrados++;
          return Promise.resolve();
        }
        
        // Verificar se o status é válido
        if (!row["Novo Status"] || !STATUS_OPTIONS.includes(row["Novo Status"])) {
          statusInvalidos++;
          return Promise.resolve();
        }
        
        // Buscar e atualizar o pedido
        return db.collection("pedidos")
          .where("numero", "==", parseInt(row["Número do Pedido"]))
          .get()
          .then(snap => {
            if (snap.empty) {
              naoEncontrados++;
              return;
            }
            
            const promessasAtualizacao = [];
            snap.forEach(doc => {
              const dados = doc.data();
              const historico = dados.historico || [];
              historico.push({ 
                status: row["Novo Status"], 
                data: new Date().toISOString() 
              });
              
              promessasAtualizacao.push(
                doc.ref.update({ 
                  status: row["Novo Status"], 
                  historico: historico 
                })
              );
            });
            
            return Promise.all(promessasAtualizacao).then(() => {
              atualizados += snap.size;
            });
          })
          .catch(error => {
            console.error("Erro ao atualizar pedido:", error);
            return Promise.resolve();
          });
      });
      
      // Processar todas as promessas e mostrar resultado
      Promise.all(promessas)
        .then(() => {
          hideLoadingIndicator();
          
          let mensagem = `Atualização concluída! ${atualizados} pedidos atualizados.`;
          let tipo = "success";
          
          if (naoEncontrados > 0 || statusInvalidos > 0) {
            mensagem += ` (${naoEncontrados} não encontrados, ${statusInvalidos} status inválidos)`;
            tipo = atualizados > 0 ? "warning" : "error";
          }
          
          showNotification(mensagem, tipo);
          
          // Limpar o input de arquivo
          document.getElementById("arquivoStatus").value = "";
        })
        .catch(error => {
          console.error("Erro na atualização em massa:", error);
          hideLoadingIndicator();
          showNotification("Ocorreu um erro durante a atualização. Tente novamente.", "error");
        });
    } catch (error) {
      console.error("Erro ao processar planilha:", error);
      hideLoadingIndicator();
      showNotification("Erro ao processar a planilha. Verifique se o formato está correto.", "error");
    }
  };
  
  reader.onerror = function() {
    hideLoadingIndicator();
    showNotification("Erro ao ler o arquivo. Tente novamente.", "error");
  };
  
  reader.readAsArrayBuffer(file);
}

// Exportação para Excel
function exportarExcel() {
  showLoadingIndicator();
  
  try {
    const wb = XLSX.utils.book_new();
    const linhas = [];
    
    todosPedidos.forEach(p =>
      p.materiais.forEach(m => linhas.push({
        "Número do Pedido": p.numero,
        "Colaborador": p.colaborador,
        "Focal": p.Focal,
        "Status do Pedido": p.status,
        "Material": m.material,
        "Quantidade": m.quantidade,
        "Status do Item": m.status || p.status,
        "Observações": p.observacoes || "",
        "Data": new Date(p.data).toLocaleString()
      }))
    );
    
    const ws = XLSX.utils.json_to_sheet(linhas);
    XLSX.utils.book_append_sheet(wb, ws, "Pedidos");
    
    // Timeout para simular processamento
    setTimeout(() => {
      XLSX.writeFile(wb, "Pedidos_Materiais.xlsx");
      hideLoadingIndicator();
      showNotification("Exportação concluída com sucesso!", "success");
    }, 1000);
  } catch (error) {
    console.error("Erro ao exportar para Excel:", error);
    hideLoadingIndicator();
    showNotification("Erro ao exportar dados. Tente novamente.", "error");
  }
}

// Funções para Exportação Filtrada
function inicializarFiltrosExportacao() {
  // Popular filtro de focais
  const selectFocal = document.getElementById("exportFiltroFocal");
  if (selectFocal) {
    // Limpar opções existentes (exceto "Todos os Focais")
    while (selectFocal.children.length > 1) {
      selectFocal.removeChild(selectFocal.lastChild);
    }
    
    // Obter focais únicos dos pedidos
    const focaisUnicos = [...new Set(todosPedidos.map(p => p.Focal).filter(f => f))];
    focaisUnicos.sort().forEach(focal => {
      const option = document.createElement("option");
      option.value = focal;
      option.textContent = focal;
      selectFocal.appendChild(option);
    });
  }
  
  // Atualizar contador de resultados
  atualizarContadorResultados();
}

function atualizarContadorResultados() {
  const contador = document.getElementById("contadorResultados");
  if (contador) {
    const pedidosFiltrados = aplicarFiltrosExportacao();
    let totalItens = 0;
    pedidosFiltrados.forEach(p => totalItens += p.materiais.length);
    contador.textContent = `${pedidosFiltrados.length} pedidos (${totalItens} itens) encontrados`;
  }
}

function aplicarFiltrosExportacao() {
  let pedidosFiltrados = [...todosPedidos];
  
  // Filtro por Focal
  const focaisSelecionados = Array.from(document.getElementById("exportFiltroFocal").selectedOptions)
    .map(option => option.value).filter(v => v);
  if (focaisSelecionados.length > 0) {
    pedidosFiltrados = pedidosFiltrados.filter(p => focaisSelecionados.includes(p.Focal));
  }
  
  // Filtro por Status do Pedido
  const statusPedidoSelecionados = Array.from(document.getElementById("exportFiltroStatusPedido").selectedOptions)
    .map(option => option.value).filter(v => v);
  if (statusPedidoSelecionados.length > 0) {
    pedidosFiltrados = pedidosFiltrados.filter(p => statusPedidoSelecionados.includes(p.status));
  }
  
  // Filtro por Status do Item
  const statusItemSelecionados = Array.from(document.getElementById("exportFiltroStatusItem").selectedOptions)
    .map(option => option.value).filter(v => v);
  if (statusItemSelecionados.length > 0) {
    pedidosFiltrados = pedidosFiltrados.filter(p => 
      p.materiais.some(m => statusItemSelecionados.includes(m.status || p.status))
    );
  }
  
  // Filtro por Material
  const filtroMaterial = document.getElementById("exportFiltroMaterial").value.trim().toLowerCase();
  if (filtroMaterial) {
    pedidosFiltrados = pedidosFiltrados.filter(p => 
      p.materiais.some(m => m.material.toLowerCase().includes(filtroMaterial))
    );
  }
  
  // Filtro por Colaborador
  const filtroColaborador = document.getElementById("exportFiltroColaborador").value.trim().toLowerCase();
  if (filtroColaborador) {
    pedidosFiltrados = pedidosFiltrados.filter(p => 
      p.colaborador.toLowerCase().includes(filtroColaborador)
    );
  }
  
  // Filtro por Data
  const dataInicio = document.getElementById("exportDataInicio").value;
  const dataFim = document.getElementById("exportDataFim").value;
  
  if (dataInicio) {
    const inicio = new Date(dataInicio);
    pedidosFiltrados = pedidosFiltrados.filter(p => new Date(p.data) >= inicio);
  }
  
  if (dataFim) {
    const fim = new Date(dataFim);
    fim.setHours(23, 59, 59, 999); // Incluir todo o dia
    pedidosFiltrados = pedidosFiltrados.filter(p => new Date(p.data) <= fim);
  }
  
  return pedidosFiltrados;
}

function exportarExcelFiltrado() {
  showLoadingIndicator();
  
  try {
    const pedidosFiltrados = aplicarFiltrosExportacao();
    
    if (pedidosFiltrados.length === 0) {
      hideLoadingIndicator();
      showNotification("Nenhum pedido encontrado com os filtros aplicados.", "warning");
      return;
    }
    
    // Obter colunas selecionadas
    const colunasSelecionadas = {
      numeroPedido: document.getElementById("colNumeroPedido").checked,
      colaborador: document.getElementById("colColaborador").checked,
      focal: document.getElementById("colFocal").checked,
      statusPedido: document.getElementById("colStatusPedido").checked,
      material: document.getElementById("colMaterial").checked,
      quantidade: document.getElementById("colQuantidade").checked,
      statusItem: document.getElementById("colStatusItem").checked,
      observacoes: document.getElementById("colObservacoes").checked,
      data: document.getElementById("colData").checked
    };
    
    const wb = XLSX.utils.book_new();
    const linhas = [];
    
    pedidosFiltrados.forEach(p => {
      p.materiais.forEach(m => {
        const linha = {};
        
        if (colunasSelecionadas.numeroPedido) linha["Número do Pedido"] = p.numero;
        if (colunasSelecionadas.colaborador) linha["Colaborador"] = p.colaborador;
        if (colunasSelecionadas.focal) linha["Focal"] = p.Focal;
        if (colunasSelecionadas.statusPedido) linha["Status do Pedido"] = p.status;
        if (colunasSelecionadas.material) linha["Material"] = m.material;
        if (colunasSelecionadas.quantidade) linha["Quantidade"] = m.quantidade;
        if (colunasSelecionadas.statusItem) linha["Status do Item"] = m.status || p.status;
        if (colunasSelecionadas.observacoes) linha["Observações"] = p.observacoes || "";
        if (colunasSelecionadas.data) linha["Data"] = new Date(p.data).toLocaleString();
        
        linhas.push(linha);
      });
    });
    
    const ws = XLSX.utils.json_to_sheet(linhas);
    XLSX.utils.book_append_sheet(wb, ws, "Pedidos_Filtrados");
    
    // Timeout para simular processamento
    setTimeout(() => {
      const nomeArquivo = `Pedidos_Filtrados_${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, nomeArquivo);
      hideLoadingIndicator();
      showNotification(`Exportação concluída! ${linhas.length} itens exportados.`, "success");
    }, 1000);
    
  } catch (error) {
    console.error("Erro ao exportar dados filtrados:", error);
    hideLoadingIndicator();
    showNotification("Erro ao exportar dados. Tente novamente.", "error");
  }
}

function limparFiltrosExportacao() {
  // Limpar todos os filtros
  document.getElementById("exportFiltroFocal").selectedIndex = -1;
  document.getElementById("exportFiltroStatusPedido").selectedIndex = -1;
  document.getElementById("exportFiltroStatusItem").selectedIndex = -1;
  document.getElementById("exportFiltroMaterial").value = "";
  document.getElementById("exportFiltroColaborador").value = "";
  document.getElementById("exportDataInicio").value = "";
  document.getElementById("exportDataFim").value = "";
  
  // Marcar todas as colunas
  document.getElementById("colNumeroPedido").checked = true;
  document.getElementById("colColaborador").checked = true;
  document.getElementById("colFocal").checked = true;
  document.getElementById("colStatusPedido").checked = true;
  document.getElementById("colMaterial").checked = true;
  document.getElementById("colQuantidade").checked = true;
  document.getElementById("colStatusItem").checked = true;
  document.getElementById("colObservacoes").checked = true;
  document.getElementById("colData").checked = true;
  
  // Atualizar contador
  atualizarContadorResultados();
  
  showNotification("Filtros limpos com sucesso!", "info");
}

// Gráfico de Status
function gerarGraficoStatus(pedidos) {
  const contagem = {};
  
  // Inicializar contagem para todos os status
  STATUS_OPTIONS.forEach(status => {
    contagem[status] = 0;
  });
  
  // Contar pedidos por status
  pedidos.forEach(p => {
    contagem[p.status] = (contagem[p.status] || 0) + 1;
  });
  
  // Filtrar apenas status com contagem > 0
  const labels = [];
  const data = [];
  const backgroundColor = [];
  
  // Função para converter variáveis CSS em valores reais de cor
  function getCSSColorValue(cssVar) {
    // Extrair o nome da variável CSS da string var(--nome)
    const varName = cssVar.match(/var\(([^)]+)\)/)[1];
    // Obter o valor real da variável CSS
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }
  
  // Cores reais para cada status
  const coresReais = {
    "Solicitação Recebida": "#9c27b0",     // roxo
    "Reserva Gerada": "#1976d2",           // azul
    "Aguardando Verba": "#FFA500",         // laranja
    "Reserva Apropriada": "#ec407a",       // rosa
    "Disponível para Retirada": "#757575", // cinza
    "Material Entregue": "#2e7d32",        // verde
    "Pedido Cancelado": "#ff0000"          // vermelho
  };
  
  Object.keys(contagem).forEach(status => {
    if (contagem[status] > 0) {
      labels.push(status);
      data.push(contagem[status]);
      // Usar cores reais em vez de variáveis CSS
      backgroundColor.push(coresReais[status]);
    }
  });
  
  // Verificar se já existe um gráfico e destruí-lo
  const chartElement = document.getElementById("graficoStatus");
  const chartInstance = Chart.getChart(chartElement);
  if (chartInstance) {
    chartInstance.destroy();
  }
  
  // Criar novo gráfico
  new Chart(chartElement, {
    type: "pie",
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: backgroundColor
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: {
            padding: 20,
            boxWidth: 12,
            font: {
              size: 12
            }
          }
        },
        datalabels: {
          color: "#fff",
          font: { weight: "bold" },
          formatter: (value, ctx) => {
            const total = ctx.dataset.data.reduce((acc, val) => acc + val, 0);
            const percentage = (value * 100 / total).toFixed(1) + '%';
            return value > 0 ? percentage : '';
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// Tabela de Pedidos Recentes
function atualizarTabelaPedidosRecentes() {
  const tbody = document.querySelector("#tabelaPedidosRecentes tbody");
  tbody.innerHTML = "";
  
  // Pegar os 5 pedidos mais recentes
  const pedidosRecentes = todosPedidos.slice(0, 5);
  
  pedidosRecentes.forEach(p => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.numero}</td>
      <td>${p.colaborador}</td>
      <td>${new Date(p.data).toLocaleDateString()}</td>
      <td>
        <span class="badge ${STATUS_BADGES[p.status] || 'badge-received'}">${p.status}</span>
      </td>
      <td>
        <div style="display: flex; gap: var(--space-2);">
          <button class="btn-icon" title="Ver detalhes" onclick="mostrarSecao('pedidos')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn-icon" title="Editar" onclick="mostrarSecao('pedidos')">
            <i class="fas fa-edit"></i>
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// KPIs
function atualizarKPIs(pedidos) {
  const recebidos = pedidos.filter(p => p.status === "Solicitação Recebida").length;
  const gerados = pedidos.filter(p => p.status === "Reserva Gerada").length;
  const apropriados = pedidos.filter(p => p.status === "Reserva Apropriada").length;
  const cancelados = pedidos.filter(p => p.status === "Pedido Cancelado").length;
  const almoxarifado = pedidos.filter(p => p.status === "Aguardando Almoxarifado").length;
  const aguardandoMaterial = pedidos.filter(p => p.status === "Aguardando Material").length;

  document.getElementById("kpi-recebidos").textContent = recebidos;
  document.getElementById("kpi-gerados").textContent = gerados;
  document.getElementById("kpi-apropriados").textContent = apropriados;
  document.getElementById("kpi-cancelados").textContent = cancelados;
  document.getElementById("kpi-almoxarifado").textContent = almoxarifado;
  document.getElementById("kpi-aguardando-material").textContent = aguardandoMaterial;

  // Total de pedidos
  document.getElementById("kpi-total").textContent = pedidos.length;
  
  // Aguardando Verba
  const aguardandoVerba = pedidos.filter(p => p.status === "Aguardando Verba").length;
  document.getElementById("kpi-aguardando").textContent = aguardandoVerba;
  
  // Disponíveis para Retirada
  const disponiveis = pedidos.filter(p => p.status === "Disponível para Retirada").length;
  document.getElementById("kpi-disponiveis").textContent = disponiveis;
  
  // Entregues
  const entregues = pedidos.filter(p => p.status === "Material Entregue").length;
  document.getElementById("kpi-entregues").textContent = entregues;
}

// UI Helpers
function showLoadingIndicator() {
  document.getElementById("loadingIndicator").style.display = "flex";
}

function hideLoadingIndicator() {
  document.getElementById("loadingIndicator").style.display = "none";
}

function showNotification(message, type = 'info') {
  const container = document.getElementById('notificationContainer');
  
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  
  let icon = 'info-circle';
  if (type === 'success') icon = 'check-circle';
  if (type === 'error') icon = 'exclamation-circle';
  if (type === 'warning') icon = 'exclamation-triangle';
  
  notification.innerHTML = `
    <div class="notification-icon">
      <i class="fas fa-${icon}"></i>
    </div>
    <div class="notification-content">
      <h4 class="notification-title">${type.charAt(0).toUpperCase() + type.slice(1)}</h4>
      <p class="notification-message">${message}</p>
    </div>
    <button class="notification-close">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  notification.querySelector('.notification-close').addEventListener('click', () => {
    notification.classList.add('notification-hiding');
    setTimeout(() => notification.remove(), 300);
  });
  
  container.appendChild(notification);
  
  // Auto-remover após 5 segundos
  setTimeout(() => {
    if (notification.parentNode) {
      notification.classList.add('notification-hiding');
      setTimeout(() => notification.remove(), 300);
    }
  }, 5000);
}

function showConfirmationModal(title, message, callback) {
  const modal = document.getElementById('confirmationModal');
  modal.querySelector('.modal-title').textContent = title;
  modal.querySelector('.modal-body p').textContent = message;
  
  // Armazenar callback
  confirmCallback = callback;
  
  // Configurar botão de confirmação
  const confirmButton = document.getElementById('confirmAction');
  confirmButton.onclick = function() {
    if (confirmCallback) confirmCallback();
    fecharModal('confirmationModal');
  };
  
  // Mostrar modal
  modal.classList.add('show');
}

function fecharModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.remove('show');
  confirmCallback = null;
}

// Funções para a aba de relatórios
function gerarRelatorio() {
  showLoadingIndicator();
  
  try {
    const tipoRelatorio = document.getElementById("tipoRelatorio").value;
    const dataInicio = document.getElementById("dataInicioRelatorio").value;
    const dataFim = document.getElementById("dataFimRelatorio").value;
    
    // Validar datas
    if (dataInicio && dataFim && new Date(dataInicio) > new Date(dataFim)) {
      hideLoadingIndicator();
      showNotification("A data de início deve ser anterior à data de fim", "error");
      return;
    }
    
    // Filtrar pedidos por data se especificado
    let pedidosFiltrados = [...todosPedidos];
    
    if (dataInicio) {
      const dataInicioObj = new Date(dataInicio);
      dataInicioObj.setHours(0, 0, 0, 0);
      pedidosFiltrados = pedidosFiltrados.filter(p => new Date(p.data) >= dataInicioObj);
    }
    
    if (dataFim) {
      const dataFimObj = new Date(dataFim);
      dataFimObj.setHours(23, 59, 59, 999);
      pedidosFiltrados = pedidosFiltrados.filter(p => new Date(p.data) <= dataFimObj);
    }
    
    // Verificar se há dados
    if (pedidosFiltrados.length === 0) {
      hideLoadingIndicator();
      showNotification("Não há dados para o período selecionado", "warning");
      return;
    }
    
    // Gerar relatório conforme o tipo selecionado
    switch (tipoRelatorio) {
      case "status":
        gerarRelatorioStatus(pedidosFiltrados);
        break;
      case "mensal":
        gerarRelatorioMensal(pedidosFiltrados);
        break;
      case "colaborador":
        gerarRelatorioColaborador(pedidosFiltrados);
        break;
    }
    
    // Registrar ação
    const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
    if (usuarioLogado) {
      let descricaoRelatorio = "Relatório de ";
      if (tipoRelatorio === "status") descricaoRelatorio += "Distribuição por Status";
      else if (tipoRelatorio === "mensal") descricaoRelatorio += "Pedidos Mensais";
      else if (tipoRelatorio === "colaborador") descricaoRelatorio += "Pedidos por Colaborador";
      
      registrarAcao("Geração de Relatório", descricaoRelatorio, {
        tipoRelatorio: tipoRelatorio,
        dataInicio: dataInicio || "Não especificada",
        dataFim: dataFim || "Não especificada",
        quantidadePedidos: pedidosFiltrados.length
      });
    }
    
    // Mostrar a seção de resultado
    document.getElementById("resultadoRelatorio").style.display = "block";
    
    hideLoadingIndicator();
    showNotification("Relatório gerado com sucesso!", "success");
  } catch (error) {
    console.error("Erro ao gerar relatório:", error);
    hideLoadingIndicator();
    showNotification("Erro ao gerar relatório. Tente novamente.", "error");
  }
}

function gerarRelatorioStatus(pedidos) {
  // Configurar título
  document.getElementById("tituloResultadoRelatorio").textContent = "Relatório de Distribuição por Status";
  
  // Contagem por status
  const contagemStatus = {};
  STATUS_OPTIONS.forEach(status => {
    contagemStatus[status] = 0;
  });
  
  // Contar pedidos por status
  pedidos.forEach(p => {
    contagemStatus[p.status] = (contagemStatus[p.status] || 0) + 1;
  });
  
  // Contar itens por status
  const contagemItens = {};
  STATUS_OPTIONS.forEach(status => {
    contagemItens[status] = 0;
  });
  
  pedidos.forEach(p => {
    p.materiais.forEach(m => {
      const itemStatus = m.status || p.status;
      contagemItens[itemStatus] = (contagemItens[itemStatus] || 0) + 1;
    });
  });
  
  // Preparar dados para a tabela
  const dados = [];
  STATUS_OPTIONS.forEach(status => {
    if (contagemStatus[status] > 0 || contagemItens[status] > 0) {
      dados.push({
        status: status,
        pedidos: contagemStatus[status],
        itens: contagemItens[status],
        percentualPedidos: ((contagemStatus[status] / pedidos.length) * 100).toFixed(2) + "%"
      });
    }
  });
  
  // Renderizar tabela
  const thead = document.querySelector("#tabelaRelatorio thead");
  const tbody = document.querySelector("#tabelaRelatorio tbody");
  
  thead.innerHTML = `
    <tr>
      <th>Status</th>
      <th>Quantidade de Pedidos</th>
      <th>Quantidade de Itens</th>
      <th>% do Total</th>
    </tr>
  `;
  
  tbody.innerHTML = "";
  dados.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <span class="badge ${STATUS_BADGES[row.status]}">${row.status}</span>
      </td>
      <td>${row.pedidos}</td>
      <td>${row.itens}</td>
      <td>${row.percentualPedidos}</td>
    `;
    tbody.appendChild(tr);
  });
  
  // Adicionar linha de total
  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.innerHTML = `
    <td>Total</td>
    <td>${pedidos.length}</td>
    <td>${pedidos.reduce((total, p) => total + p.materiais.length, 0)}</td>
    <td>100%</td>
  `;
  tbody.appendChild(trTotal);
}

function gerarRelatorioMensal(pedidos) {
  // Configurar título
  document.getElementById("tituloResultadoRelatorio").textContent = "Relatório Mensal de Pedidos";
  
  // Agrupar por mês
  const pedidosPorMes = {};
  
  pedidos.forEach(p => {
    const data = new Date(p.data);
    const mesAno = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
    
    if (!pedidosPorMes[mesAno]) {
      pedidosPorMes[mesAno] = {
        pedidos: 0,
        itens: 0,
        statusCounts: {}
      };
      
      STATUS_OPTIONS.forEach(status => {
        pedidosPorMes[mesAno].statusCounts[status] = 0;
      });
    }
    
    pedidosPorMes[mesAno].pedidos++;
    pedidosPorMes[mesAno].itens += p.materiais.length;
    pedidosPorMes[mesAno].statusCounts[p.status]++;
  });
  
  // Ordenar meses
  const mesesOrdenados = Object.keys(pedidosPorMes).sort();
  
  // Renderizar tabela
  const thead = document.querySelector("#tabelaRelatorio thead");
  const tbody = document.querySelector("#tabelaRelatorio tbody");
  
  thead.innerHTML = `
    <tr>
      <th>Mês/Ano</th>
      <th>Total de Pedidos</th>
      <th>Total de Itens</th>
      <th>Status Predominante</th>
    </tr>
  `;
  
  tbody.innerHTML = "";
  mesesOrdenados.forEach(mesAno => {
    const dados = pedidosPorMes[mesAno];
    
    // Encontrar status predominante
    let statusPredominante = "";
    let maxCount = 0;
    
    Object.keys(dados.statusCounts).forEach(status => {
      if (dados.statusCounts[status] > maxCount) {
        maxCount = dados.statusCounts[status];
        statusPredominante = status;
      }
    });
    
    // Formatar mês/ano para exibição
    const [ano, mes] = mesAno.split('-');
    const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const mesFormatado = `${meses[parseInt(mes) - 1]} de ${ano}`;
    
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${mesFormatado}</td>
      <td>${dados.pedidos}</td>
      <td>${dados.itens}</td>
      <td>
        <span class="badge ${STATUS_BADGES[statusPredominante]}">${statusPredominante}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Adicionar linha de total
  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.innerHTML = `
    <td>Total</td>
    <td>${pedidos.length}</td>
    <td>${pedidos.reduce((total, p) => total + p.materiais.length, 0)}</td>
    <td></td>
  `;
  tbody.appendChild(trTotal);
}

function gerarRelatorioColaborador(pedidos) {
  // Configurar título
  document.getElementById("tituloResultadoRelatorio").textContent = "Relatório de Pedidos por Colaborador";
  
  // Agrupar por colaborador
  const pedidosPorColaborador = {};
  
  pedidos.forEach(p => {
    if (!pedidosPorColaborador[p.colaborador]) {
      pedidosPorColaborador[p.colaborador] = {
        pedidos: 0,
        itens: 0,
        statusCounts: {}
      };
      
      STATUS_OPTIONS.forEach(status => {
        pedidosPorColaborador[p.colaborador].statusCounts[status] = 0;
      });
    }
    
    pedidosPorColaborador[p.colaborador].pedidos++;
    pedidosPorColaborador[p.colaborador].itens += p.materiais.length;
    pedidosPorColaborador[p.colaborador].statusCounts[p.status]++;
  });
  
  // Ordenar colaboradores por número de pedidos (decrescente)
  const colaboradoresOrdenados = Object.keys(pedidosPorColaborador).sort((a, b) => 
    pedidosPorColaborador[b].pedidos - pedidosPorColaborador[a].pedidos
  );
  
  // Renderizar tabela
  const thead = document.querySelector("#tabelaRelatorio thead");
  const tbody = document.querySelector("#tabelaRelatorio tbody");
  
  thead.innerHTML = `
    <tr>
      <th>Colaborador</th>
      <th>Total de Pedidos</th>
      <th>Total de Itens</th>
      <th>Status Predominante</th>
    </tr>
  `;
  
  tbody.innerHTML = "";
  colaboradoresOrdenados.forEach(colaborador => {
    const dados = pedidosPorColaborador[colaborador];
    
    // Encontrar status predominante
    let statusPredominante = "";
    let maxCount = 0;
    
    Object.keys(dados.statusCounts).forEach(status => {
      if (dados.statusCounts[status] > maxCount) {
        maxCount = dados.statusCounts[status];
        statusPredominante = status;
      }
    });
    
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${colaborador}</td>
      <td>${dados.pedidos}</td>
      <td>${dados.itens}</td>
      <td>
        <span class="badge ${STATUS_BADGES[statusPredominante]}">${statusPredominante}</span>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Adicionar linha de total
  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.innerHTML = `
    <td>Total</td>
    <td>${pedidos.length}</td>
    <td>${pedidos.reduce((total, p) => total + p.materiais.length, 0)}</td>
    <td></td>
  `;
  tbody.appendChild(trTotal);
}

function exportarRelatorioExcel() {
  showLoadingIndicator();
  
  try {
    const tipoRelatorio = document.getElementById("tipoRelatorio").value;
    const tituloRelatorio = document.getElementById("tituloResultadoRelatorio").textContent;
    
    // Obter dados da tabela
    const tabela = document.getElementById("tabelaRelatorio");
    
    if (!tabela || !tabela.rows || tabela.rows.length <= 1) {
      hideLoadingIndicator();
      showNotification("Não há dados para exportar. Gere um relatório primeiro.", "warning");
      return;
    }
    
    const workbook = XLSX.utils.book_new();
    
    // Converter tabela HTML para planilha
    const worksheet = XLSX.utils.table_to_sheet(tabela);
    
    // Adicionar planilha ao workbook
    XLSX.utils.book_append_sheet(workbook, worksheet, tipoRelatorio);
    
    // Gerar o arquivo Excel
    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    
    // Criar link para download
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${tituloRelatorio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`;
    document.body.appendChild(a);
    
    // Registrar ação
    const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
    if (usuarioLogado) {
      registrarAcao("Exportação de Relatório", `Relatório "${tituloRelatorio}" exportado para Excel`, {
        tipoRelatorio: tipoRelatorio,
        dataExportacao: new Date().toISOString()
      });
    }
    
    // Pequeno delay para garantir que o indicador de carregamento seja exibido
    setTimeout(() => {
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      hideLoadingIndicator();
      showNotification("Relatório exportado com sucesso!", "success");
    }, 500);
  } catch (error) {
    console.error("Erro ao exportar relatório:", error);
    hideLoadingIndicator();
    showNotification("Erro ao exportar relatório. Tente novamente.", "error");
  }
}

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
  verificaLogin();
  
  // Event listeners para filtros de exportação
  setTimeout(() => {
    // Adicionar event listeners para atualizar contador quando filtros mudarem
    const filtros = [
      'exportFiltroFocal',
      'exportFiltroStatusPedido', 
      'exportFiltroStatusItem',
      'exportFiltroMaterial',
      'exportFiltroColaborador',
      'exportDataInicio',
      'exportDataFim'
    ];
    
    filtros.forEach(filtroId => {
      const elemento = document.getElementById(filtroId);
      if (elemento) {
        if (elemento.tagName === 'SELECT') {
          elemento.addEventListener('change', atualizarContadorResultados);
        } else {
          elemento.addEventListener('input', atualizarContadorResultados);
        }
      }
    });
  }, 1000);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.status-geral').forEach(select => {
    select.addEventListener('change', function () {
      const pedidoId = this.dataset.pedidoId;
      const reservaDiv = document.getElementById(`reserva-${pedidoId}`);
      const inputReserva = document.getElementById(`numero-reserva-${pedidoId}`);
      
      if (this.value === 'Reserva Gerada') {
        reservaDiv.style.display = 'block';
        inputReserva.required = true;
      } else {
        reservaDiv.style.display = 'none';
        inputReserva.required = false;
      }
    });
  });
});
</script>
<script>
function customPrompt(message, callback) {
  const backdrop = document.createElement("div");
  backdrop.className = "custom-prompt-backdrop";

  const container = document.createElement("div");
  container.className = "custom-prompt-container";

  const label = document.createElement("label");
  label.textContent = message;

  const input = document.createElement("input");
  input.type = "text";
  input.placeholder = "Ex: 456789";

  const buttonsDiv = document.createElement("div");
  buttonsDiv.className = "custom-prompt-buttons";

  const confirmBtn = document.createElement("button");
  confirmBtn.className = "confirm";
  confirmBtn.textContent = "Confirmar";

  const cancelBtn = document.createElement("button");
  cancelBtn.className = "cancel";
  cancelBtn.textContent = "Cancelar";

  confirmBtn.onclick = () => {
    document.body.removeChild(backdrop);
    callback(input.value);
  };
  cancelBtn.onclick = () => {
    document.body.removeChild(backdrop);
    callback(null);
  };

  buttonsDiv.appendChild(confirmBtn);
  buttonsDiv.appendChild(cancelBtn);

  container.appendChild(label);
  container.appendChild(input);
  container.appendChild(buttonsDiv);
  backdrop.appendChild(container);
  document.body.appendChild(backdrop);
}

// Substitui a função de atualização com prompt estilizado
const originalAtualizarStatusIndividual = atualizarStatusIndividual;
atualizarStatusIndividual = function(id, valor) {
  if (valor === "Reserva Gerada") {
    customPrompt("Informe o número da reserva:", (numeroReserva) => {
      if (!numeroReserva || numeroReserva.trim() === "") {
        showNotification("Por favor, insira o número da reserva.", "warning");
        return;
      }

      processarStatus(id, valor, numeroReserva.trim());
    });
  } else {
    processarStatus(id, valor, null);
  }
};

function processarStatus(id, valor, numeroReserva) {
  showConfirmationModal(
    "Confirmar alteração de status",
    `Deseja alterar o status do pedido para "${valor}"?`,
    () => {
      showLoadingIndicator();
      const ref = db.collection("pedidos").doc(id);
      ref.get().then(doc => {
        if (doc.exists) {
          const dados = doc.data();
          const historico = dados.historico || [];
          const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));

          historico.push({
            status: valor,
            data: new Date().toISOString(),
            usuario: usuarioLogado ? usuarioLogado.usuario : "sistema",
            nome: usuarioLogado ? usuarioLogado.nome : "Sistema"
          });

          // Atualizar também os status dos itens individuais
          const materiais = dados.materiais || [];
          materiais.forEach(material => {
            // Criar ou atualizar o histórico do item
            if (!material.historico) {
              material.historico = [];
            }
            
            // Adicionar entrada ao histórico do item
            material.historico.push({
              status: valor,
              data: new Date().toISOString(),
              usuario: usuarioLogado ? usuarioLogado.usuario : "sistema",
              nome: usuarioLogado ? usuarioLogado.nome : "Sistema"
            });
            
            // Atualizar o status do item
            material.status = valor;
          });

          let observacoes = dados.observacoes || "";
          if (valor === "Reserva Gerada" && numeroReserva) {
            observacoes += (observacoes ? " | " : "") + "Reserva Gerada Nº " + numeroReserva;
          }

          ref.update({ status: valor, historico: historico, observacoes: observacoes, materiais: materiais })
            .then(() => {
              hideLoadingIndicator();
              showNotification(`Status do pedido atualizado para "${valor}"`, "success");
              registrarAcao("Alteração de Status", `Status do pedido ${dados.numero} alterado para "${valor}"`, {
                pedidoId: id,
                numeroPedido: dados.numero,
                statusAntigo: dados.status,
                statusNovo: valor,
                numeroReserva: numeroReserva || undefined
              });
              
              // Reaplicar filtros para manter a filtragem ativa
              aplicarFiltros();
            })
            .catch(error => {
              hideLoadingIndicator();
              showNotification("Erro ao atualizar status. Tente novamente.", "error");
              console.error("Erro:", error);
            });
        }
      });
    }
  );
}
</script></body>
</html>
